<html lang="ja">
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="copyright" content="Copyright (c) 2014 IBM Corporation. All rights reserved. This program and the accompanying materials are made available under the terms of the Eclipse Public License v1.0 which accompanies this distribution, and is available at  http://www.eclipse.org/legal/epl-v10.html" >
<title>みんなのアルバム 地図</title>
<link rel="stylesheet" type="text/css" href="css/style.css" media="all"/>
<script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.10.4.custom.min.js"></script>
<script src="js/album-service.js"></script>
<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false&language=ja"></script>
<script type="text/javascript">
  
var pram=window.location.href;
var api=pram.split("#");
var key=api[1].split("=");
var apiKey=key[1];
//alert(apiKey);
var url = "https://please_replace_with_target_URL/web/api.php/elmember/search?apiKey="+apiKey;
//data=user_id,user_name
var portal;
$.ajax({
  url: url,
  type: 'GET',
  dataType: 'json',
  //data: '{"test": "テスト"}',
  success : function(data) {
	  portal=data;
	},
});

  var serviceRoot = cfelService.serviceRoot.slice(0, -1);
  
  var geocoder = new google.maps.Geocoder();

   /*
	 * 基本API
	 */
	function findPhoto(query, callback) {
		cfelService.apiKey = apiKey;
		cfelService.getPhotoList({
			"query" : query
		}, callback);
	}
  
	/*
	 * callback
	 */
	function showResult(result) {
		if (result.status == "success") {
			$("#result").text(JSON.stringify(result.data));
		} else {
			$("#result").text("status: " + result.status);
		}
	}
  function getImageURLS(callback) {
	  cfelService.apiKey = apiKey;
		cfelService.getPhotoList({
			"query" : null,
			"keys" : {
				"_id" : 1,
        "portal_image_url" : 1,
        "marker_image_url" : 1,
        "title" : 1,
				"exif_location" : 1,
        "annotation_season" : 1,
        "annotation_title" :1,
        "annotation_location": 1
			}
		}, callback);
	}
  
  function annotationLocation(photo, lon, lat, address, callback) {
	  	cfelService.apiKey = apiKey;
		var id = cfelService.getID(photo);
		if (!id | !lon) {
			return;
		}
		cfelService.updatePhoto(id, {
			"update" : {
				"$push" : {
          "annotation_location" : {
        	  "portal_id" : portal.id,
              "portal_name" : portal.name,
        	  "lon" : lon,
              "lat" : lat,
              "address" : address
          }
        }
			},
			"upsert" : true
		}, callback);
	}
  
  function next(){
  //callback
  }
  
  var annotateLocation=[5];
  
  function getLocation(result) {
		if (result.status == "success") {
    var myOptions = {
      zoom: 18,
      center: new google.maps.LatLng(34.826724,135.3193), //34.826953,135.319488
      //center: new google.maps.LatLng(latitude,longitude),
      mapTypeId: google.maps.MapTypeId.HYBRID
    }
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
    map.panTo(pos);
    var image=[];
    var contentString=[];
    var iconSize = new google.maps.Size(130,100);
    var iconOffset = new google.maps.Point(0,0);
    var iconAnchor = new google.maps.Point(65,100);
    var iconScaleSize = new google.maps.Size(130,100);
    
    var sampleLocation=[
      ["34.8255541995125","135.31899774405497"],
      ["34.82719592858477","135.3195630859833"],
      ["34.82667163206722","135.3207963154831"],
      ["34.826627560806585","135.3182915495986"],
      ["34.826139","135.319955"]
    ];
    
			var jsonText = result.data;
      var count=0;
      var num=0;
      for(var i=0; i<jsonText.length; i++){
        if(!jsonText[i].exif_location && !jsonText[i].annotation_location){
          var lat = sampleLocation[count][0];
          var lon = sampleLocation[count][1];
          if(jsonText[i].annotation_title){
            var oTitle = jsonText[i].annotation_title[jsonText[i].annotation_title.length-1].title;
          }else{
            var oTitle = jsonText[i].title;
          }
          if(!oTitle)oTitle="このリンクをタッチすると大きな画像が見えます";
          var oURL = jsonText[i].portal_image_url;
          if(oURL.match(/photo/)){
            var url = oURL.replace("\/photo","photo");
            oURL = url;
          }
          var mURL = serviceRoot + jsonText[i].marker_image_url;
          //alert(mURL);
          annotateLocation[count]=jsonText[i];
          var image = new google.maps.MarkerImage(mURL,iconSize,iconOffset,iconAnchor,iconScaleSize);
          var name='<a href="'+oURL + '" target="_blank"><h2>'+oTitle+'</h2></a>';
          var latlng = new google.maps.LatLng(lat,lon);
          createMarker(name,latlng,map,image,count);
          count++;
          if(count==4)break;
     }}
     
     /* 地図上にカスタムコントロールを追加 */
			var homeControlDiv = document.createElement('DIV');
			var homeControl = new HomeControl(homeControlDiv, map);
			homeControlDiv.index = 1;
			/* カスタムコントロールを地図の右上に配置 */
			map.controls[google.maps.ControlPosition.RIGHT_TOP].push(homeControlDiv);
      //alert(num);
		} else {
			 alert(result.status);
		}
	}

  function createMarker(name,latlng,map,image,count){
    var infoWindow = new google.maps.InfoWindow();
    var marker = new google.maps.Marker({position: latlng,map: map,icon: image,draggable: true});
    //infoWindow.setContent(name);
    //infoWindow.open(map,marker); 
    google.maps.event.addListener(marker, "dragstart", function(ev) {
        document.getElementById("result").value += String(count)+"MoveStart:"+ev.latLng.lat()+","+ev.latLng.lng()+"<br>";
      });
      
      google.maps.event.addListener(marker, "drag", function(ev) {
        document.getElementById("result").value += "Move:"+ev.latLng.lat()+","+ev.latLng.lng()+"<br>";
      });

      // マーカーのドロップ（ドラッグ終了）時のイベント
      google.maps.event.addListener( marker, 'dragend', function(ev){
      //alert(count);
        document.getElementById('latitude'+String(count)).value = ev.latLng.lat();
        document.getElementById('longitude'+String(count)).value = ev.latLng.lng();
        geocodePosition(ev.latLng,count);
        document.getElementById("result").value += "MoveEnd:"+ev.latLng.lat()+","+ev.latLng.lng()+"<br>";
        //alert(ev.title);
        // function updatePhoto(photo[i][location]); // update
      });
      
      google.maps.event.addListener(map, "zoom_changed", function() {
        var z = map.getZoom();
        document.getElementById("result").value += "Zoom_changed："+z+"<br>";
      });
      
      google.maps.event.addListener(marker, 'click', function() {
        infoWindow.setContent(name);
        infoWindow.open(map,marker);   
      });
      
  } 
  
  function geocodePosition(pos,count) {
    geocoder.geocode({
      latLng: pos
    }, function(responses) {
      if (responses && responses.length > 0) {
        updateMarkerAddress(responses[0].formatted_address,count);
      } else {
        updateMarkerAddress('Cannot determine address at this location.');
      }
    });
  }
  function updateMarkerAddress(str,count) {
    document.getElementById('address'+String(count)).value = str;
    annotationLocation(annotateLocation[count],document.getElementById('longitude'+String(count)).value,document.getElementById('latitude'+String(count)).value,str,next);
  }
  
  /* 基本位置の緯度・経度 */
	var pos = new google.maps.LatLng(35.681382, 139.766084);　//please replace

		function HomeControl(controlDiv, map) {
			/* ボタン枠 */
			controlDiv.style.padding = '5px';
			controlDiv.style.backgroundColor = '#ffffcc';
			controlDiv.style.border = '1px solid #000';
			controlDiv.style.cursor = 'pointer';
			controlDiv.style.textAlign = 'center';

			/* ボタン */
			var controlUI = document.createElement('DIV');
			controlUI.style.backgroundColor = '#ffffff';
			controlUI.style.border = '1px solid #000';
			controlUI.style.float = 'left';
			controlUI.style.cursor = 'pointer';
			controlUI.style.textAlign = 'center';
			controlUI.style.marginRight = '5px';
			controlUI.title = 'ホームに戻る';
			controlDiv.appendChild(controlUI);

			var controlText = document.createElement('div');
			controlText.style.fontFamily = 'Arial,sans-serif';
			controlText.style.fontSize = '30px';
			controlText.style.padding = '2px 5px';
			controlText.innerHTML = '<b>ホームに戻る</b>';
			controlUI.appendChild(controlText);
			
			google.maps.event.addDomListener(controlUI, 'click', function() {
				map.panTo(pos);
			});
		}
  
var get_current_timestamp = function() {
    var weeks = new Array('日', '月', '火', '水', '木', '金', '土');
    var d = new Date();
 
    // 年月日・曜日・時分秒の取得
    var month  = d.getMonth() + 1;
    var day    = d.getDate();
    var week   = weeks[ d.getDay() ];
    var hour   = d.getHours();
    var minute = d.getMinutes();
    var second = d.getSeconds();
 
    // 1桁を2桁に変換する
    if (month < 10) {month = "0" + month;}
    if (day < 10) {day = "0" + day;}
    if (hour < 10) {hour = "0" + hour;}
    if (minute < 10) {minute = "0" + minute;}
    if (second < 10) {second = "0" + second;}
 
    // 整形して返却
    return d.getFullYear()  + "-" + month + "-" + day + "T" + hour + ":" + minute + ":" + second + ".000Z";
}
 
// 現在の日付・時刻を表示する
//document.write(get_current_timestamp());
//alert(get_current_timestamp());

function jump(){
	parent.location.href='annotation_map.html#apiKey='+apiKey;
}
function restart(){
	location.href='mapTask.html#apiKey='+apiKey;
}
</script>
</head>
<body>
<input type=hidden id="apiKey">
<table><tbody><tr>
<td><h1>写真を正しい場所に移動させてください</h1></td>
<td><input type="button" value="完了" class="btn" style="height:60px;" onClick="jump()"></td>
<td><input type="button" value="やり直す" class="btn2" style="width:140px;height:60px;" onClick="restart()"></td></tr></tbody></table>
<div id="map_canvas" style="float:left;width:100%;height:80%"></div>
<!--div name="spot_list" style="float:right;width:30%;height:100%;"></div-->
<div id="update">
<form>
	<input type="hidden" id="latitude0" size="20" />
	<input type="hidden" id="longitude0" size="20" />
	<input type="hidden" id="address0" size="36" />
	<input type="hidden" id="latitude1" size="20" />
	<input type="hidden" id="longitude1" size="20" />
	<input type="hidden" id="address1" size="36" />
	<input type="hidden" id="latitude2" size="20" />
	<input type="hidden" id="longitude2" size="20" />
	<input type="hidden" id="address2" size="36" />
	<input type="hidden" id="latitude3" size="20" />
	<input type="hidden" id="longitude3" size="20" />
	<input type="hidden" id="address3" size="36" />
  
  <input type="hidden" id="result"></div>
</form>
<script type="text/javascript">
getImageURLS(getLocation);
</script>

</body>
</html>