<!DOCTYPE html>
<html lang="ja">  
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
<meta name="copyright" content="Copyright (c) 2014 IBM Corporation. All rights reserved. This program and the accompanying materials are made available under the terms of the Eclipse Public License v1.0 which accompanies this distribution, and is available at  http://www.eclipse.org/legal/epl-v10.html" >
<title>みんなのアルバム　アルバムの並び替え</title>
<link rel="stylesheet" type="text/css" href="css/style.css" media="all"/>
<script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.10.4.custom.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/development-bundle/themes/base/jquery-ui.css" media="all"/>
<script type="text/javascript" src="js/jquery.ui.touch-punch.min.js"></script>
<script src="js/album-service.js"></script>
<script type="text/javascript">  
<!--
  var serviceRoot = cfelService.serviceRoot.slice(0, -1);

  /*
	 * 基本API
	 */
	function findPhoto(query, callback) {
		cfelService.apiKey = apiKey;
		cfelService.getPhotoList({
			"query" : query
		}, callback);
	}
  
	/*
	 * callback
	 */
	function showResult(result) {
		if (result.status == "success") {
			$("#result").text(JSON.stringify(result.data));
		} else {
			$("#result").text("status: " + result.status);
		}
	}
  function getImageURLS(callback) {
	  cfelService.apiKey = apiKey;
		cfelService.getPhotoList({
			"query" : null,
			"keys" : {
				"_id" : 1,
        "portal_image_url" : 1,
        "thumbnail_image_url" : 1,
        "title" : 1,
				"exif_date" : 1,
        "annotation_season" : 1,
        "annotation_title" :1
			}
		}, callback);
	}
  
  function annotationSeason(photo, value, callback) {
	  	cfelService.apiKey = apiKey;
		var id = cfelService.getID(photo);
		if (!id | !value) {
			return;
		}
		cfelService.updatePhoto(id, {
			"update" : {
				"$push" : {
          "annotation_season" : {
            "season" : value
          }
        }
			},
			"upsert" : true
		}, callback);
	}
  
  function next(){
  //callback
  }
  
  var season_card=[15];
  
  function sortPhoto(result) {
		if (result.status == "success") {
			var jsonText = result.data;
      var count=0;
      var num=0;
      
      
      var elm_div = document.createElement("div"); // div要素を作成する
      elm_div.style.background="#ff0000";
      elm_div.innerHTML='<h1><font color="#ffffff" size=7>春</font></h1>';
      document.getElementById("table").appendChild(elm_div);
      var elm_tr = document.createElement("tr"); // tr要素を作成する
      for(i=0;i<3;i++){
        var random=~~(Math.random()*(jsonText.length-0)+0);
        //alert(random);       
        var tURL = serviceRoot + jsonText[random].thumbnail_image_url;
        season_card[count]=jsonText[random];
        count++;
        var elm_td = document.createElement("td"); // td要素を生成
        elm_td.innerHTML='<li class="jquery-ui-sortable-item"><div class="ui-state-default"><img src="'+tURL+'" align="center" width="200" height="200"/></div></li>';
        elm_tr.appendChild(elm_td); // tr要素にtd要素を追加
      }
      document.getElementById("table").appendChild(elm_tr);
      
      var elm_div = document.createElement("div"); // tr要素を作成する
      elm_div.style.background="#ff0000";
      elm_div.innerHTML='<h1><font color="#ffffff" size=7>夏</font></h1>';
      document.getElementById("table").appendChild(elm_div);
      var elm_tr = document.createElement("tr"); // tr要素を作成する
      for(i=0;i<3;i++){
        var random=~~(Math.random()*(jsonText.length-0)+0);
        //alert(random);       
        var tURL = serviceRoot + jsonText[random].thumbnail_image_url;
        season_card[count]=jsonText[random];
        count++;
        var elm_td = document.createElement("td"); // td要素を生成
        elm_td.innerHTML='<li class="jquery-ui-sortable-item"><div class="ui-state-default"><img src="'+tURL+'" align="center" width="200" height="200"/></div></li>';
        elm_tr.appendChild(elm_td); // tr要素にtd要素を追加
      }
      document.getElementById("table").appendChild(elm_tr);
      
      var elm_div = document.createElement("div"); // tr要素を作成する
      elm_div.style.background="#ff0000";
      elm_div.innerHTML='<h1><font color="#ffffff" size=7>秋</font></h1>';
      document.getElementById("table").appendChild(elm_div);
      var elm_tr = document.createElement("tr"); // tr要素を作成する
      for(i=0;i<3;i++){
        var random=~~(Math.random()*(jsonText.length-0)+0);
        //alert(random);       
        var tURL = serviceRoot + jsonText[random].thumbnail_image_url;
        season_card[count]=jsonText[random];
        count++;
        var elm_td = document.createElement("td"); // td要素を生成
        elm_td.innerHTML='<li class="jquery-ui-sortable-item"><div class="ui-state-default"><img src="'+tURL+'" align="center" width="200" height="200"/></div></li>';
        elm_tr.appendChild(elm_td); // tr要素にtd要素を追加
      }
      document.getElementById("table").appendChild(elm_tr);
      
      var elm_div = document.createElement("div"); // tr要素を作成する
      elm_div.style.background="#ff0000";
      elm_div.innerHTML='<h1><font color="#ffffff" size=7>冬</font></h1>';
      document.getElementById("table").appendChild(elm_div);
      var elm_tr = document.createElement("tr"); // tr要素を作成する
      for(i=0;i<3;i++){
        var random=~~(Math.random()*(jsonText.length-0)+0);
        //alert(random);       
        var tURL = serviceRoot + jsonText[random].thumbnail_image_url;
        season_card[count]=jsonText[random];
        count++;
        var elm_td = document.createElement("td"); // td要素を生成
        elm_td.innerHTML='<li class="jquery-ui-sortable-item"><div class="ui-state-default"><img src="'+tURL+'" align="center" width="200" height="200"/></div></li>';
        elm_tr.appendChild(elm_td); // tr要素にtd要素を追加
      }
      document.getElementById("table").appendChild(elm_tr);
      
		} else {
			 alert(result.status);
		}
    enhanceElements(1);
	}

function enhanceElements(status){
  //alert("element");
  if(status==1){
    $( '#jquery-ui-sortable' ) . sortable({
      items: '.jquery-ui-sortable-item',
      handle: 'div',
    });
    $( '#jquery-ui-sortable' ) . disableSelection();
    jQuery( '#submitSortable' ) . click( function() {
        var itemNames = '';
        var itemIDs = '';
        
        var count_spring=0;
        var count_summer=0;
        var count_autumn=0;
        var count_winter=0;
        
        var divList = document.getElementById("table").getElementsByTagName("div");
        for(i=0;i<divList.length;i++){
          var div = divList[i].innerHTML;
          if(div.match(/夏/))count_spring=i-1;
          else if(div.match(/秋/))count_summer=i-count_spring-2;
          else if(div.match(/冬/))count_autumn=i-count_spring-count_summer-3;
        }
        count_winter=divList.length-count_spring-count_summer-count_autumn-4;
        //alert("春:"+count_spring+"夏:"+count_summer+"秋:"+count_autumn+"冬:"+count_winter);
        
        var count=0;
        jQuery( '#jquery-ui-sortable li' ) . map( function() {
            //itemNames += jQuery( this ) . text() + '\n';
            var temp = jQuery( this ) .find( 'img' ) . attr('src').split('/');
            var flag=0;
            for(i=0;i<season_card.length;i++){
              var link = season_card[i].portal_image_url;
              if(link.match(temp[temp.length-1]))flag=i;
            }
            if(flag<count_spring){
                //alert(flag);
                //alert("春");
                //alert(link);
                //alert(temp[temp.length-1]);
                annotationSeason(season_card[flag], "春", next);
              }else if(flag>=count_spring && flag<count_spring+count_summer){
                //alert(flag);
                //alert("夏");
                //alert(link);
                //alert(temp[temp.length-1]);
                annotationSeason(season_card[flag], "夏", next);
              }else if(flag>=count_spring+count_summer && flag<count_spring+count_summer+count_autumn){
                //alert(flag);
                //alert("秋");
                //alert(link);
                //alert(temp[temp.length-1]);
                annotationSeason(season_card[flag], "秋", next);
              }else if(flag>=count_spring+count_summer+count_autumn){ 
                //alert(flag);
                //alert("冬");
                //alert(link);
                //alert(temp[temp.length-1]);
                annotationSeason(season_card[flag], "冬", next);
              }
        } );
    } );
  }
};

var get_current_timestamp = function() {
    var weeks = new Array('日', '月', '火', '水', '木', '金', '土');
    var d = new Date();
 
    // 年月日・曜日・時分秒の取得
    var month  = d.getMonth() + 1;
    var day    = d.getDate();
    var week   = weeks[ d.getDay() ];
    var hour   = d.getHours();
    var minute = d.getMinutes();
    var second = d.getSeconds();
 
    // 1桁を2桁に変換する
    if (month < 10) {month = "0" + month;}
    if (day < 10) {day = "0" + day;}
    if (hour < 10) {hour = "0" + hour;}
    if (minute < 10) {minute = "0" + minute;}
    if (second < 10) {second = "0" + second;}
 
    // 整形して返却
    return d.getFullYear()  + "/" + month + "/" + day + "（" + week + "） " + hour + ":" + minute + ":" + second;
}
 
// 現在の日付・時刻を表示する
//document.write(get_current_timestamp());
//alert(get_current_timestamp());
  
</script>

</head>

<body>
<div id='result' type="hidden"></div>
<table><tbody>
<tr>
<td><h1>季節ごとに並び替えてください</h1></td>
<td><input type="button" class="btn" id="submitSortable" value="並び替え終了"></td>
</tr>
</tbody></table>
<!--h1>時間帯ごとに並び替えてください</h1-->

<ul id="jquery-ui-sortable">
    <table id="table" cellpadding="0" cellspacing="30"><tbody></tbody></table>
    <script type="text/javascript">
        getImageURLS(sortPhoto);
    </script>
</ul>

</body>
</html>